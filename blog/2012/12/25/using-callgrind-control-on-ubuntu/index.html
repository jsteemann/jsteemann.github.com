
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Using callgrind_control on Ubuntu - blog4j</title>
  <meta name="author" content="jsteemann">

  
  <meta name="description" content="Profiling a process with callgrind is very helpful as it provides valuable insights into how often certain functions are called and how long the &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://jsteemann.github.com/blog/2012/12/25/using-callgrind-control-on-ubuntu/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="blog4j" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">blog4j</a></h1>
  
    <h2>Some random tech notes</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:jsteemann.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Using Callgrind_control on Ubuntu</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-12-25T21:30:00+01:00" pubdate data-updated="true">Dec 25<span>th</span>, 2012</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Profiling a process with callgrind is very helpful as it provides valuable insights into how often certain functions are called and how long the program spends executing them. This helps identifying bottlenecks and potential optimisations.</p>

<p>Callgrind is contained in the Valgrind toolset, and it is easy to invoke by just prefxing the actual program command with <code>valgrind --tool=callgrind</code>, e.g.:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>valgrind --tool<span class="o">=</span>callgrind bin/arangod --console /tmp/test
</span></code></pre></td></tr></table></div></figure>


<p>Callgrind will profile the complete run of the program, including program startup and shutdown.
This is often not what one wants. Often it is required to profile just a specific part or function of the overall program. But this information might get buried in the tons of profile data generated by callgrind.</p>

<p>I found the easiest way to get profile data for a specific part is to the start the program with callgrind and it get to the state just before it will execute the to-be-profiled function.
Then, in another terminal session, all event counters of callgrind should be cleared. This can be achieved by running the <code>callgrind_control -z</code> comand from another terminal, using the process id of the profiled program, e.g.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>callgrind_control -z 4740
</span></code></pre></td></tr></table></div></figure>


<p>Then the interesting part of the program can be run. When done, a final <code>callgrind_control --dump</code> command with the process id of the profiled program forces callgrind to dump the collected profile data to a file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>callgrind_control --dump 4740
</span></code></pre></td></tr></table></div></figure>


<p>That&#8217;s it, apart from the problem that <code>callgrind_control</code> does not work properly on Ubuntu 12.04.</p>

<p>Whenever invoking <code>callgrind_control</code> it could not find the process that callgrind was attached to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>&gt; callgrind_control -z 4740
</span><span class='line'>Error: Callgrind task with PID/name <span class="s1">&#39;4740&#39;</span> not detected.
</span><span class='line'>&gt; callgrind_control -z arangod
</span><span class='line'>Error: Callgrind task with PID/name <span class="s1">&#39;arangod&#39;</span> not detected.
</span></code></pre></td></tr></table></div></figure>


<p>This sucks, especially as it works well with other Linux distributions. It&#8217;s likely to be some Ubuntu-specific bug.</p>

<p>I checked this and found that <code>callgrind_control</code> is just a Perl-script:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>&gt; which callgrind_control
</span><span class='line'>/usr/bin/callgrind_control
</span><span class='line'>&gt; file /usr/bin/callgrind_control
</span><span class='line'>/usr/bin/callgrind_control: a /usr/bin/perl -w script, ASCII text executable
</span></code></pre></td></tr></table></div></figure>


<p>It will look for running Valgrind processes with the command <code>vgdb -l</code>, and from this list of processes try to find the one the user specified.</p>

<p>When running the above program with callgrind, <code>vgdb -l</code> will produce the following output on my machine:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>use --pid<span class="o">=</span>4740 <span class="k">for</span> /usr/bin/valgrind.bin --tool<span class="o">=</span>callgrind bin/arangod --console /tmp/test
</span></code></pre></td></tr></table></div></figure>


<p>This list with then processed is then processing with a Perl regex for matches. The interesting part looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='perl'><span class='line'><span class="nb">open</span> <span class="n">LIST</span><span class="p">,</span> <span class="s">&quot;vgdb -l|&quot;</span><span class="p">;</span>
</span><span class='line'><span class="k">while</span><span class="p">(</span><span class="sr">&lt;LIST&gt;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="sr">/^use --pid=(\d+) for \S*?valgrind\s+(.*?)\s*$/</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="o">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ok, now the reason is clear: <code>callgrind_control</code> will look for entries with the program <code>valgrind</code>, but <code>vgdb -l</code> will produce entries with the name <code>valgrind.bin</code>. The regex will not match <code>valgrind.bin</code>.</p>

<p>Finally, to make <code>callgrind_control</code> run on Ubuntu, the regex must be fixed to</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='perl'><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="sr">/^use --pid=(\d+) for \S*?valgrind\.bin\s+(.*?)\s*$/</span><span class="p">)</span> <span class="p">{</span>
</span></code></pre></td></tr></table></div></figure>


<p>or something similar.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">jsteemann</span></span>

      








  


<time datetime="2012-12-25T21:30:00+01:00" pubdate data-updated="true">Dec 25<span>th</span>, 2012</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/ubuntu/'>Ubuntu</a>, <a class='category' href='/blog/categories/callgrind/'>callgrind</a>, <a class='category' href='/blog/categories/profiling/'>profiling</a>, <a class='category' href='/blog/categories/valgrind/'>valgrind</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://jsteemann.github.com/blog/2012/12/25/using-callgrind-control-on-ubuntu/" data-via="steemann" data-counturl="http://jsteemann.github.com/blog/2012/12/25/using-callgrind-control-on-ubuntu/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2012/12/22/unused-function-mysteries/" title="Previous Post: Unused function C compiler mysteries">&laquo; Unused function C compiler mysteries</a>
      
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/12/25/using-callgrind-control-on-ubuntu/">Using callgrind_control on Ubuntu</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/22/unused-function-mysteries/">Unused function C compiler mysteries</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/19/setting-up-octopress/">Setting up Octopress</a>
      </li>
    
  </ul>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("steemann", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/steemann" class="twitter-follow-button" data-show-count="false">Follow @steemann</a>
  
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - jsteemann -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
